
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Image Compressor</title>
  <style>
    :root {
      --blue: #0ea5ff; /* bright blue */
      --blue-600: #0284c7;
      --blue-700: #0369a1;
      --bg: #ffffff;
      --text: #0b1220;
      --muted: #5b7083;
      --card: #ffffff;
      --card-border: #e6f4ff;
      --shadow: 0 10px 30px rgba(14, 165, 255, 0.15);
      --radius: 18px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: linear-gradient(180deg, #f5fbff 0%, #ffffff 60%);
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      gap: 20px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 42px; height: 42px;
      border-radius: 12px;
      background: conic-gradient(from 210deg, var(--blue), #a0e2ff);
      box-shadow: var(--shadow);
    }

    h1 {
      font-size: clamp(20px, 4vw, 32px);
      margin: 0;
      letter-spacing: 0.2px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: 1.1fr 0.9fr;
      }
    }

    .uploader {
      border: 2px dashed var(--blue);
      border-radius: var(--radius);
      padding: 22px;
      text-align: center;
      background: #f0faff;
      transition: all 0.2s ease;
      cursor: pointer;
      outline: none;
    }
    .uploader:focus-visible { box-shadow: 0 0 0 3px rgba(14,165,255,0.4); }
    .uploader.dragover {
      background: #e6f6ff;
      transform: translateY(-1px);
    }

    .uploader .hint {
      color: var(--muted);
      font-size: 14px;
    }

    .btn {
      appearance: none;
      border: none;
      background: var(--blue);
      color: white;
      padding: 12px 16px;
      border-radius: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 8px 20px rgba(14,165,255,0.35);
      transition: transform 0.06s ease, filter 0.2s ease;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background: #e8f6ff;
      color: var(--blue-700);
      box-shadow: none;
      border: 1px solid #c7eaff;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .control {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 12px;
      background: #f8fdff;
      border: 1px solid #e7f4ff;
      border-radius: 14px;
      padding: 12px 14px;
    }

    .control label { font-weight: 600; }
    .control small { color: var(--muted); display: block; }

    .slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%; height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--blue), #a0e2ff);
      outline: none;
    }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%; background: white; border: 2px solid var(--blue); box-shadow: var(--shadow); cursor: pointer; }
    .slider::-moz-range-thumb { width: 22px; height: 22px; border-radius: 50%; background: white; border: 2px solid var(--blue); box-shadow: var(--shadow); cursor: pointer; }

    .previews {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 700px) {
      .previews { grid-template-columns: 1fr 1fr; }
    }

    .preview {
      background: #ffffff;
      border: 1px solid #e7f4ff;
      border-radius: 16px;
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .preview header { display: flex; justify-content: space-between; align-items: center; }
    .preview h3 { margin: 0; font-size: 16px; }
    .meta { color: var(--muted); font-size: 13px; }

    .canvas-wrap {
      display: grid;
      place-items: center;
      background: #f7fbff;
      border: 1px dashed #d8eeff;
      border-radius: 12px;
      min-height: 220px;
      overflow: hidden;
    }

    canvas, img { max-width: 100%; height: auto; display: block; }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

    footer { text-align: center; color: var(--muted); font-size: 13px; padding: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Image Compressor</h1>
      </div>
      <button class="btn secondary" id="resetBtn" type="button" disabled>Reset</button>
    </header>

    <div class="grid">
      <!-- LEFT: Upload + Controls -->
      <section class="card" aria-labelledby="upload-title">
        <h2 id="upload-title" style="margin-top:0">Upload & Settings</h2>

        <label for="file" class="uploader" id="dropzone" tabindex="0">
          <input id="file" type="file" accept="image/*" class="sr-only" />
          <strong>Click to upload</strong> or drag & drop an image here
          <div class="hint">PNG • JPG • WebP • GIF (first frame)</div>
        </label>

        <div class="controls" style="margin-top:16px">
          <div class="control">
            <div>
              <label for="quality">Quality</label>
              <small>Adjust compression level (JPG/WebP only)</small>
            </div>
            <div style="min-width: 220px;">
              <input id="quality" class="slider" type="range" min="40" max="100" value="80" />
              <div class="row" style="justify-content: space-between; font-size: 13px; color: var(--muted);">
                <span>Smaller</span><strong id="qVal">80%</strong><span>Sharper</span>
              </div>
            </div>
          </div>

          <div class="control">
            <div>
              <label for="maxSize">Max Dimensions</label>
              <small>Resize to fit within width × height (px)</small>
            </div>
            <div class="row">
              <input id="maxW" type="number" min="64" step="1" placeholder="Width" style="width: 110px; padding: 10px; border:1px solid #cfeaff; border-radius: 12px;" />
              <span style="color: var(--muted);">×</span>
              <input id="maxH" type="number" min="64" step="1" placeholder="Height" style="width: 110px; padding: 10px; border:1px solid #cfeaff; border-radius: 12px;" />
              <button id="fitOriginal" class="btn secondary" type="button" title="Use original size">Use original</button>
            </div>
          </div>

          <div class="control">
            <div>
              <label for="format">Output Format</label>
              <small>Choose the compressed file type</small>
            </div>
            <div class="row">
              <select id="format" style="padding: 10px 12px; border:1px solid #cfeaff; border-radius: 12px; min-width: 160px;">
                <option value="auto" selected>Auto (keep or best)</option>
                <option value="image/jpeg">JPEG</option>
                <option value="image/webp">WebP</option>
                <option value="image/png">PNG (lossless)</option>
              </select>
              <button id="compressBtn" class="btn" type="button" disabled>Compress</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Previews -->
      <section class="card" aria-labelledby="preview-title">
        <h2 id="preview-title" style="margin-top:0">Preview</h2>
        <div class="previews">
          <div class="preview">
            <header>
              <h3>Original</h3>
              <div class="meta" id="origMeta">—</div>
            </header>
            <div class="canvas-wrap"><img id="origImg" alt="Original preview" /></div>
          </div>
          <div class="preview">
            <header>
              <h3>Compressed</h3>
              <div class="meta" id="compMeta">—</div>
            </header>
            <div class="canvas-wrap"><canvas id="canvas" aria-label="Compressed preview"></canvas></div>
            <div class="row" style="justify-content: space-between;">
              <a id="downloadLink" class="btn" href="#" download="compressed.jpg" style="visibility:hidden">Download</a>
              <button id="copyBtn" class="btn secondary" type="button" style="visibility:hidden">Copy to Clipboard</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <footer>All processing happens in your browser. Your images never leave your device.</footer>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const dropzone = document.getElementById('dropzone');
    const qualityInput = document.getElementById('quality');
    const qVal = document.getElementById('qVal');
    const maxW = document.getElementById('maxW');
    const maxH = document.getElementById('maxH');
    const fitOriginal = document.getElementById('fitOriginal');
    const formatSelect = document.getElementById('format');
    const compressBtn = document.getElementById('compressBtn');
    const resetBtn = document.getElementById('resetBtn');

    const origImg = document.getElementById('origImg');
    const origMeta = document.getElementById('origMeta');
    const canvas = document.getElementById('canvas');
    const compMeta = document.getElementById('compMeta');
    const downloadLink = document.getElementById('downloadLink');
    const copyBtn = document.getElementById('copyBtn');

    let originalFile = null;
    let originalURL = null;

    // Helpers
    const formatBytes = (bytes) => {
      if (!Number.isFinite(bytes)) return '—';
      const units = ['B','KB','MB','GB'];
      let i = 0; let n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(n < 10 && i > 0 ? 2 : 0)} ${units[i]}`;
    };

    const getBestType = (inputType) => {
      // Heuristic: prefer WebP for photographic content, else keep type
      if (inputType === 'image/png' || inputType === 'image/gif') return 'image/webp';
      return inputType || 'image/jpeg';
    };

    const setBusy = (busy) => {
      compressBtn.disabled = busy || !originalFile;
      resetBtn.disabled = !originalFile || busy;
    };

    // Drag & drop
    ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover');
    }));
    ;['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover');
    }));
    dropzone.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files?.[0];
      if (file) handleFile(file);
    });

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }});
    fileInput.addEventListener('change', () => { const f = fileInput.files?.[0]; if (f) handleFile(f); });

    qualityInput.addEventListener('input', () => { qVal.textContent = qualityInput.value + '%'; });

    fitOriginal.addEventListener('click', () => {
      if (!origImg.naturalWidth) return;
      maxW.value = origImg.naturalWidth;
      maxH.value = origImg.naturalHeight;
    });

    resetBtn.addEventListener('click', () => {
      originalFile = null;
      if (originalURL) URL.revokeObjectURL(originalURL);
      originalURL = null;
      fileInput.value = '';
      origImg.src = '';
      origMeta.textContent = '—';
      canvas.width = canvas.height = 0;
      compMeta.textContent = '—';
      downloadLink.style.visibility = 'hidden';
      copyBtn.style.visibility = 'hidden';
      setBusy(false);
    });

    async function handleFile(file) {
      if (!file || !file.type.startsWith('image/')) {
        alert('Please choose a valid image file.');
        return;
      }
      originalFile = file;
      if (originalURL) URL.revokeObjectURL(originalURL);
      originalURL = URL.createObjectURL(file);
      origImg.src = originalURL;

      await new Promise(r => { origImg.onload = () => r(); });
      const { naturalWidth: w, naturalHeight: h } = origImg;
      origMeta.textContent = `${w}×${h}px • ${file.type || 'unknown'} • ${formatBytes(file.size)}`;

      // Default max size: match original on first load
      maxW.placeholder = w;
      maxH.placeholder = h;

      setBusy(false);
      compressBtn.disabled = false;
      downloadLink.style.visibility = 'hidden';
      copyBtn.style.visibility = 'hidden';
    }

    function computeTargetSize(srcW, srcH) {
      const limW = parseInt(maxW.value || maxW.placeholder, 10);
      const limH = parseInt(maxH.value || maxH.placeholder, 10);
      const ratio = Math.min(limW / srcW, limH / srcH, 1); // never upscale
      return { w: Math.round(srcW * ratio), h: Math.round(srcH * ratio) };
    }

    async function compress() {
      if (!originalFile) return;
      try {
        setBusy(true);
        const imgBitmap = await createImageBitmap(originalFile, { imageOrientation: 'from-image' }).catch(() => null);
        // Fallback if createImageBitmap fails (e.g., Safari with certain formats)
        const img = document.createElement('img');
        img.src = originalURL;
        await new Promise(r => img.decode ? img.decode().then(r).catch(() => r()) : img.onload = () => r());
        const srcW = imgBitmap ? imgBitmap.width : img.naturalWidth;
        const srcH = imgBitmap ? imgBitmap.height : img.naturalHeight;
        const { w, h } = computeTargetSize(srcW, srcH);

        const ctx = canvas.getContext('2d', { alpha: true });
        canvas.width = w; canvas.height = h;
        ctx.clearRect(0, 0, w, h);
        if (imgBitmap) {
          ctx.drawImage(imgBitmap, 0, 0, w, h);
        } else {
          ctx.drawImage(img, 0, 0, w, h);
        }

        const requested = formatSelect.value;
        const autoType = requested === 'auto' ? getBestType(originalFile.type) : requested;
        const isQualityType = ['image/jpeg','image/webp'].includes(autoType);
        const q = Math.max(0.4, Math.min(1, (parseInt(qualityInput.value,10) || 80) / 100));

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, autoType, isQualityType ? q : undefined));
        if (!blob) throw new Error('Compression failed');

        // Update UI
        const compURL = URL.createObjectURL(blob);
        downloadLink.href = compURL;
        const ext = autoType.includes('png') ? 'png' : autoType.includes('webp') ? 'webp' : 'jpg';
        const baseName = (originalFile.name?.replace(/\.[^.]+$/, '') || 'compressed');
        downloadLink.download = `${baseName}.${ext}`;
        downloadLink.style.visibility = 'visible';

        // Clipboard support (optional)
        if (navigator.clipboard && window.ClipboardItem) {
          copyBtn.onclick = async () => {
            try {
              await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
              copyBtn.textContent = 'Copied!';
              setTimeout(() => (copyBtn.textContent = 'Copy to Clipboard'), 1200);
            } catch (e) { alert('Clipboard copy failed: ' + e.message); }
          };
          copyBtn.style.visibility = 'visible';
        }

        const saving = originalFile.size ? Math.max(0, (1 - blob.size / originalFile.size) * 100) : 0;
        compMeta.textContent = `${w}×${h}px • ${autoType} • ${formatBytes(blob.size)} (${saving.toFixed(0)}% smaller)`;
      } catch (err) {
        console.error(err);
        alert(err.message || 'Something went wrong while compressing.');
      } finally {
        setBusy(false);
      }
    }

    compressBtn.addEventListener('click', compress);
  </script>
</body>
</html>
