<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YouTube Video Downloader — MultiImageX</title>
<meta name="description" content="Download YouTube videos in MP4/WebM or extract audio (MP3) — MultiImageX downloader (server required)." />
<style>
  body{font-family:Inter,system-ui,Arial;margin:0;background:#f7fafc;color:#0b1220}
  header{background:linear-gradient(90deg,#2563eb,#7c5cff);color:#fff;padding:16px;text-align:center}
  .wrap{max-width:920px;margin:18px auto;padding:14px}
  .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
  .row{display:flex;gap:8px;align-items:center}
  input,select,button{padding:10px;border-radius:8px;border:1px solid #e6eef8}
  button{background:#2563eb;color:#fff;border:none;cursor:pointer}
  .muted{color:#6b7280;font-size:13px}
  .formats{margin-top:12px;display:none}
  .formats label{display:block;padding:8px;background:#f1f5f9;border-radius:6px;margin-bottom:6px;cursor:pointer}
  progress{width:100%}
  a.download{display:inline-block;margin-top:12px;padding:10px 14px;background:#10b981;color:#fff;border-radius:8px;text-decoration:none}
</style>
</head>
<body>
<header><h1>YouTube Video Downloader</h1></header>
<main class="wrap">
  <div class="card">
    <label>Paste YouTube URL or ID</label>
    <div class="row" style="margin-top:8px;">
      <input id="videoUrl" style="flex:1" placeholder="YouTube link or Video ID" />
      <button id="inspectBtn">Inspect</button>
    </div>

    <div id="info" class="muted" style="margin-top:10px">Click Inspect to list available formats (server required).</div>

    <div id="formats" class="formats card" aria-hidden="true">
      <h3>Available formats</h3>
      <div id="formatsList"></div>
      <div style="margin-top:10px">
        <button id="downloadBtn">Download Selected</button>
        <div id="progressWrap" style="display:none;margin-top:8px">
          <progress id="progress" max="100" value="0"></progress>
          <div id="progressText" class="muted" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <div id="result" style="margin-top:12px"></div>
    <div style="margin-top:10px" class="muted">Server must run yt-dlp. Do not use for copyrighted content you don't own.</div>
  </div>
</main>

<script>
const API_BASE = ''; // change if server on other origin

function getVideoId(input){
  if(!input) return null;
  const s = input.trim();
  if(/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;
  try{ const u = new URL(s); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); if(u.searchParams.get('v')) return u.searchParams.get('v'); }catch(e){}
  const m = s.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
  return m? m[1] : null;
}

async function timeoutFetch(url, opts={}, ms=120000){
  return Promise.race([fetch(url, opts), new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms))]);
}

document.getElementById('inspectBtn').addEventListener('click', async ()=>{
  const raw = document.getElementById('videoUrl').value;
  const vid = getVideoId(raw);
  const info = document.getElementById('info');
  const formatsWrap = document.getElementById('formats');
  const formatsList = document.getElementById('formatsList');
  const result = document.getElementById('result');
  formatsList.innerHTML=''; result.innerHTML=''; formatsWrap.style.display='none';
  if(!vid){ info.textContent = 'Invalid URL or ID'; return; }
  info.textContent = 'Inspecting...';
  try{
    const res = await timeoutFetch(API_BASE + '/api/inspect', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url: raw })
    }, 2*60*1000);
    if(!res.ok){ info.textContent = 'Inspect failed: ' + res.status; const txt = await res.text().catch(()=>null); console.error(txt); return; }
    const j = await res.json();
    if(!j.ok) { info.textContent = 'Inspect failed: ' + (j.error||'unknown'); return; }
    const fmts = j.formats || [];
    if(!fmts.length){ info.textContent = 'No formats found'; return; }
    formatsList.innerHTML = '';
    fmts.forEach((f, idx)=>{
      const id = 'fmt-'+idx;
      const label = document.createElement('label');
      label.innerHTML = `<input type="radio" name="fmt" value="${idx}" ${idx===0?'checked':''}/> ${f.format} — ${f.ext} ${f.format_note || ''} ${f.filesize?(' - '+(Math.round(f.filesize/1024/1024*100)/100)+'MB'):''}`;
      formatsList.appendChild(label);
    });
    formatsWrap.style.display='block'; info.textContent = 'Choose a format and click Download Selected.';
    document.getElementById('downloadBtn').onclick = async ()=>{
      const sel = document.querySelector('input[name="fmt"]:checked');
      if(!sel) return alert('Select a format');
      const fobj = fmts[Number(sel.value)];
      document.getElementById('progressWrap').style.display='block';
      document.getElementById('progress').value = 5; document.getElementById('progressText').textContent = 'Queued';
      try{
        const dl = await timeoutFetch(API_BASE + '/api/download', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url: raw, format_id: fobj.format_id })
        }, 5*60*1000);
        if(!dl.ok){ const txt = await dl.text().catch(()=>null); alert('Server error: '+dl.status); console.error(txt); return; }
        const dj = await dl.json();
        if(!dj.ok){ alert('Download failed: '+(dj.error||'unknown')); return; }
        document.getElementById('progress').value = 100; document.getElementById('progressText').textContent = 'Ready';
        const a = document.createElement('a'); a.href = (dj.downloadUrl.startsWith('http')? dj.downloadUrl : (API_BASE + dj.downloadUrl));
        a.download = ''; a.className='download'; a.textContent = 'Download File';
        result.innerHTML=''; result.appendChild(a);
      }catch(err){
        alert('Download request error: ' + err.message);
      }
    };
  }catch(err){
    info.textContent = 'Inspect error: '+err.message;
    console.error(err);
  }
});
</script>
</body>
</html>
